<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta content='width=device-width, initial-scale=1' name='viewport'/>
<script charset="UTF-8">

//global variable, 100 words (the first never showup)
    var wordlist = [
"空",
"东风",
"何处",
"人间",
"风流",
"归去",
"春风",
"西风",
"归来",
"江南",
"相思",
"梅花",
"千里",
"回首",
"明月",
"多少",
"如今",
"阑干",
"年年",
"万里",
"一笑",
"黄昏",
"当年",
"天涯",
"相逢",
"芳草",
"尊前",
"一枝",
"风雨",
"流水",
"依旧",
"风吹",
"风月",
"多情",
"故人",
"当时",
"无人",
"斜阳",
"不知",
"不见",
"深处",
"时节",
"平生",
"凄凉",
"春色",
"匆匆",
"功名",
"一点",
"无限",
"今日",
"天上",
"杨柳",
"西湖",
"桃花",
"扁舟",
"消息",
"憔悴",
"何事",
"芙蓉",
"神仙",
"一片",
"桃李",
"人生",
"十分",
"心事",
"黄花",
"一声",
"佳人",
"长安",
"东君",
"断肠",
"而今",
"鸳鸯",
"为谁",
"十年",
"去年",
"少年",
"海棠",
"寂寞",
"无情",
"不是",
"时候",
"肠断",
"富贵",
"蓬莱",
"昨夜",
"行人",
"今夜",
"谁知",
"不似",
"江上",
"悠悠",
"几度",
"青山",
"何时",
"天气",
"惟有",
"一曲",
"月明",
"往事"
    ];

function myFunction() {

    
    var input_number = document.getElementById("input_number").value;
    var e = document.getElementById("input_format");
    var e_value = e.options[e.selectedIndex].value;
    e_array = e_value.split(",");
    var input_format = [];
    for (i =0; i<e_array.length; i++){
        input_format.push(parseInt(e_array[i]));
    }
    
    {
        number_array = split(input_number);
        var output = render(number_array, input_format, false);
        document.getElementById("standard").innerHTML = output;
    }
    
    {
        var number_array_size=0;
        for (i = 0; i< input_format.length; i++){
            if (input_format[i]>0){
                number_array_size += Math.floor((input_format[i]+1)/2);
            }
        }

        number_array = gen_random(input_number, number_array_size);
        var output = render(number_array, input_format, false);
        document.getElementById("random").innerHTML = output;
    }
    
}

function split(text){
    var number_array = [];
    for (i = 0; i < text.length; i+=2){
       number_array.push(parseInt(text.substring(i,i+2)));
    }
    return number_array;
}

/*
function split_random(text){
    var number_array = [];

    for (i = 0; i < text.length; ){
        var step = Math.floor(Math.random()*10) % 2 + 1; 
        var temp = parseInt(text.substring(i,i+step));
        if (temp==0){
            step +=1;
            temp = parseInt(text.substring(i,i+step));
        }
        i = i + step;
        if (isNaN(temp)){
            continue;
        }
        number_array.push(temp);
    }
    return number_array;
}

function gen_signature(text, random_factor, min_length){
    var salt = 2*3;
    var step = 2;
    
    var number_array = [];
    var signature = salt * random_factor;
    var number_array = [];
    for (i = 0; i < text.length; i+=step){
        var temp = parseInt(text.substring(i,i+step));
        if (isNaN(temp)){
            continue;
        }
        if (temp==0){
            continue;
        }
        //不要过长,最多5个词，共10个字
        if( number_array.length>=5){
            continue;
        }
        number_array.push(temp);
        signature *= temp;
    }
    
    signature = Math.log(signature);
    var work = signature;
    var visited = {};
    for (i = number_array.length; i <= min_length; i++){
        for (j=0; j<100; j++){
            var temp = Math.floor(work*100)%99 + 1;
            work = work*100 - Math.floor(work*100);
            if (!(temp in visited)){
                break;
            }
            visited[temp] = true;
        }
        number_array.push(temp);
    }
    
    return number_array;
}
*/

function gen_random(text, output_length){
    var step = 2;
    var fix_array_size = 2;
    
    var number_array = [];
    var visited = {};
    var random_array = [];
    var random_array_more = [];
    for (i = 0; i < text.length; i+=step){
        var temp = parseInt(text.substring(i,i+step));
        if (isNaN(temp)){
            continue;
        }
        if (temp==0){
            continue;
        }
        visited[temp]=true;
        if (number_array.length < fix_array_size){
            number_array.push(temp);
        }else{
            random_array.push(temp);
        }
    }
    
    for (i=1; i<wordlist.length; i++){
        if (i in visited){
            continue;
        }
        random_array_more.push(i);    
    }    
    random_array_more = shuffle(random_array_more);
    
    var num_to_be_add = output_length-random_array.length-number_array.length;
    for (i=0; i<num_to_be_add; i++){
        random_array.push(random_array_more[i]);
    }
    random_array = shuffle(random_array);

    for (i=0; i<random_array.length;  i++){
        number_array.push(random_array[i]);
    }

    return number_array;
}


// the function below is copied from stackoverflow: http://stackoverflow.com/questions/6274339/how-can-i-shuffle-an-array-in-javascript
function shuffle(array) {
    var counter = array.length, temp, index;

    // While there are elements in the array
    while (counter > 0) {
        // Pick a random index
        index = Math.floor(Math.random() * counter);

        // Decrease counter by 1
        counter--;

        // And swap the last element with it
        temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
    }

    return array;
}

function render(number_array, input_format, should_include_number) {
    var na_index =0;
    var output= "";
    if (should_include_number){
        output +=  number_array.toString() +  "<br/> " ;
    }
    for (i = 0; i< input_format.length; i++){
        if (input_format[i]==0){
            output = output.substring(0, output.length-2) + "。<br/>";
            continue;
        }
        
        for (j=0; j<input_format[i]; j+=2){
          var temp = wordlist[number_array[na_index]];
          
       //remove extra char
          if (j+1==input_format[i]){
              temp = temp.substring(0, temp.length-1);
          }
 
          na_index +=1;
          output += temp;

         if (na_index>=number_array.length){
             return output;
          }
       }
       output +=", ";
    }

    return output;

}

</script>
</head>
<title>宋词生成器</title>
<body >
<h1>宋词生成器</h1>
<p>输入一段数字，电话号码，纪念日什么的，一秒钟变成宋词风格文字</p>
<form>
数字:
<input id="input_number" size=20 value="3.1415926"/>

词牌:
<select id = "input_format">
  <option value="4,5,0,6,6,0,6,6,0,6,6,0" selected="selected">清平乐</option>
  <option value="3,5,0,7,7,0,5">忆江南</option>
  <option value="4,5,4,0,7,6,0,4,4,5,0,4,6,0,6,4,5,0,7,6,0,4,4,5,0">念奴娇</option>
  
</select>
</form>
 
<button style="font-size:120%" onclick="myFunction()">转换吧!</button>

<br/>
<br/>
转换结果:
<div style="background:#B74934; color:white; margin:10px;padding:5px;">
标准版
    <p  id="standard"></p>
</div>

<div style="background:#577492; color:white; margin:10px;padding:5px;">
随机版
    <p  id="random"></p>
</div>

<div>version 1.0, 2015-03-17</div>

</body>
</html>
